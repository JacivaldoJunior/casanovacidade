<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pagamento Casa Rio das Ostras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .paid {
      background-color: #d1fae5;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-3xl font-bold mb-4 text-green-700">Pagamento Casa Rio das Ostras</h1>
    <div class="flex flex-col md:flex-row gap-6">
      <div class="flex-1">
        <p class="mb-2 text-lg">💰 <strong>Entrada:</strong> R$ 50.000</p>
        <p class="mb-4 text-lg">📅 <strong>Mensalidade:</strong> R$ 1.000</p>
        <div id="parcelas" class="space-y-2"></div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button onclick="mostrarPagas()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ver parcelas pagas ✅</button>
          <button onclick="adicionarNovoMes()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">➕ Adicionar novo mês</button>
        </div>
      </div>
      <div class="md:w-1/2">
        <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=800&q=80" alt="Casa" class="rounded-xl shadow-md" />
      </div>
    </div>
  </div>
  <input type="file" id="comprovanteInput" class="hidden" accept="image/*,application/pdf" />
<script>
const firebaseConfig = { apiKey: "SUA_API_KEY", authDomain: "SEU_AUTH_DOMAIN", projectId: "SEU_PROJECT_ID", storageBucket: "SEU_STORAGE_BUCKET", messagingSenderId: "SEU_MESSAGING_SENDER_ID", appId: "SUA_APP_ID" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const nomesMeses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

function carregarParcelasTempoReal() {
  db.collection('parcelas').onSnapshot((snapshot) => {
    const container = document.getElementById('parcelas');
    container.innerHTML = '';
    snapshot.docs.sort((a, b) => {
      const [ma, aa] = a.id.split('/');
      const [mb, ab] = b.id.split('/');
      return parseInt(aa) - parseInt(ab) || nomesMeses.indexOf(ma) - nomesMeses.indexOf(mb);
    }).forEach((doc) => {
      const data = doc.data();
      const mes = data.mes;
      const pago = data.pago;
      const comprovanteUrl = data.comprovanteUrl;
      const bloqueado = data.bloqueado;
      const div = document.createElement('div');
      div.className = `flex flex-col md:flex-row items-start md:items-center justify-between p-3 border rounded-lg space-y-2 md:space-y-0 ${pago ? 'paid' : 'bg-gray-50'}`;
      let innerHTML = `<div><p class="font-medium text-lg">${mes}</p><p class="text-sm">Valor: R$ 1.000</p>${comprovanteUrl ? `<a href="${comprovanteUrl}" target="_blank" class="text-xs text-blue-600 underline block mt-1">📎 Comprovante</a>` : ''}${bloqueado ? `<p class="text-green-700 font-semibold mt-1">Pagamento bloqueado</p>` : ''}</div><div class="flex items-center gap-2 flex-wrap">`;
      if (!bloqueado) {
        innerHTML += `<button onclick="alternarPagamento('${mes}')" class="${pago ? 'bg-green-600' : 'bg-red-500'} text-white hover:opacity-90 px-3 py-1 rounded">${pago ? '✅ Pago' : '❌ Falta pagar'}</button><button onclick="enviarComprovante('${mes}')" class="text-sm text-blue-600 underline">Salvar comprovante</button>`;
        if (comprovanteUrl) { innerHTML += `<button onclick="excluirComprovante('${mes}')" class="text-sm text-red-600 underline">🗑️ Excluir comprovante</button>`; }
        innerHTML += `<button onclick="excluirMes('${mes}', true)" class="text-sm text-red-600 underline">🗑️ Excluir mês</button>`;
      }
      if (pago && comprovanteUrl && !bloqueado) {
        innerHTML += `<button onclick="salvarPagamentoFinal('${mes}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">💾 Salvar pagamento</button>`;
      }
      innerHTML += '</div>';
      div.innerHTML = innerHTML;
      container.appendChild(div);
    });
  });
}
async function alternarPagamento(mes) {
  const docRef = db.collection('parcelas').doc(mes);
  const doc = await docRef.get();
  if (doc.data().bloqueado) return alert("Pagamento já salvo e bloqueado.");
  await docRef.update({ pago: !doc.data().pago });
}
function enviarComprovante(mes) {
  const input = document.getElementById('comprovanteInput');
  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    const docRef = db.collection('parcelas').doc(mes);
    const doc = await docRef.get();
    if (doc.data().bloqueado) return alert("Pagamento bloqueado. Não é possível alterar o comprovante.");
    const urlCloudinary = "https://api.cloudinary.com/v1_1/do6l5tkex/upload";
    const uploadPreset = "pagamento_público";
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);
    try {
      const response = await fetch(urlCloudinary, { method: "POST", body: formData });
      const data = await response.json();
      if (data.secure_url) {
        await docRef.update({ comprovanteUrl: data.secure_url });
        alert("Comprovante salvo com sucesso!");
      } else { alert("Erro no upload do comprovante."); }
    } catch (error) { alert("Erro ao enviar comprovante: " + error.message); }
    input.value = '';
  };
  input.click();
}
async function excluirComprovante(mes) {
  if (!confirm("Tem certeza que deseja excluir o comprovante?")) return;
  const docRef = db.collection('parcelas').doc(mes);
  await docRef.update({ comprovanteUrl: "" });
}
async function excluirMes(mes, forcar = false) {
  if (!confirm("Tem certeza que deseja excluir este mês?")) return;
  const docRef = db.collection('parcelas').doc(mes);
  const doc = await docRef.get();
  if (doc.exists) {
    if (doc.data().bloqueado && !forcar) return alert("Pagamento bloqueado. Não é possível excluir o mês.");
    await docRef.delete();
  }
}
async function salvarPagamentoFinal(mes) {
  const docRef = db.collection('parcelas').doc(mes);
  await docRef.update({ bloqueado: true });
  alert("Pagamento salvo e bloqueado com sucesso.");
}
async function mostrarPagas() {
  const snapshot = await db.collection('parcelas').where('pago', '==', true).get();
  if (snapshot.empty) return alert("Nenhuma parcela paga ainda.");
  const pagas = snapshot.docs.map(doc => doc.data().mes);
  alert(`Parcelas pagas:\n\n${pagas.join('\n')}`);
}
async function adicionarNovoMes() {
  const snapshot = await db.collection('parcelas').get();
  let todosMeses = snapshot.docs.map(doc => doc.id);
  let ordenados = todosMeses.sort((a, b) => {
    const [ma, aa] = a.split('/');
    const [mb, ab] = b.split('/');
    return parseInt(aa) - parseInt(ab) || nomesMeses.indexOf(ma) - nomesMeses.indexOf(mb);
  });
  let ultimoMes = ordenados[ordenados.length -1] || "Dez/26";
  let [mesTexto, anoTexto] = ultimoMes.split('/');
  let indiceMes = nomesMeses.indexOf(mesTexto);
  let ano = parseInt(anoTexto);
  indiceMes++;
  if (indiceMes > 11) { indiceMes = 0; ano++; }
  const novoMes = `${nomesMeses[indiceMes]}/${ano}`;
  const novoDoc = await db.collection('parcelas').doc(novoMes).get();
  if (novoDoc.exists) return alert("Mês já existe!");
  await db.collection('parcelas').doc(novoMes).set({ mes: novoMes, valor: 1000, pago: false, comprovanteUrl: "", bloqueado: false });
}
window.onload = carregarParcelasTempoReal;
</script>
</body>
</html>
